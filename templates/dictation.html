{% extends "base.html" %}
{% from "_dictation_form.html" import dictation_form, dictation_result_panel %}

{% block title %}Chinese Dictation{% endblock %}

{% block content %}
    {% if story_mode and story_audio_files %}
        {% include '_story_actions.html' %}
        
        <div class="story-layout">
            <div class="dictation-header">
                <h1>{{ story_title }}</h1>
                <p class="hsk-level"><strong>Level:</strong> HSK{{ level }}</p>
            </div>
            
            {% if current and total %}
                {% include '_progress_bar.html' with context %}
            {% endif %}
            
            <div class="story-panels-row">
                {% include '_story_context_panel.html' %}
                {% include '_dictation_frame.html' with context %}
            </div>
        </div>
        
        {% include '_story_audio_modal.html' %}
        <script src="{{ url_for('static', filename='story_audio.js') }}"></script>
    {% elif conversation_mode and conversation_audio_files %}
        <div class="conversation-layout">
            <div class="dictation-header">
                <h1>{{ conversation_topic }}</h1>
                <p class="hsk-level"><strong>Level:</strong> HSK{{ level }}</p>
            </div>
            
            <div class="conversation-controls">
                <button class="play-conversation-btn" onclick="playConversationAudio()">üéµ Play Conversation Audio</button>
            </div>
            
            {% if current and total %}
                {% include '_progress_bar.html' with context %}
            {% endif %}
            
            <div class="conversation-chat-container">
                {% for sentence in conversation_sentences %}
                    <div class="chat-message {% if sentence.speaker == 'A' %}chat-message-left{% else %}chat-message-right{% endif %}">
                        {% if sentence.speaker == 'A' %}
                            <div class="speaker-circle speaker-A" onclick="playSentenceAudio('{{ sentence.audio_file }}')">‚ñ∂Ô∏è</div>
                        {% endif %}
                        <input type="text" 
                               class="chat-input-bubble" 
                               data-sentence-id="{{ sentence.id }}"
                               placeholder="Type what you hear..."
                               {% if sentence.id == current_sentence_id %}autofocus{% endif %}>
                        {% if sentence.speaker == 'B' %}
                            <div class="speaker-circle speaker-B" onclick="playSentenceAudio('{{ sentence.audio_file }}')">‚ñ∂Ô∏è</div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <script src="{{ url_for('static', filename='conversation_audio.js') }}"></script>
    {% else %}
        {% include '_regular_session_frame.html' with context %}
    {% endif %}
{% endblock %}
