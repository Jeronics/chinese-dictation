{% extends "base.html" %}
{% from "_dictation_form.html" import dictation_form %}

{% block title %}Chinese Dictation{% endblock %}

{% block content %}
    {% if story_mode %}
        <!-- Story Actions - Outside the main layout -->
        <div class="story-actions">
            <form method="POST" style="display: inline;">
                <input type="hidden" name="resume_later" value="1">
                <button type="submit" class="resume-later-btn">
                    Save & Resume Later
                </button>
            </form>
            <form method="POST" style="display: inline;">
                <input type="hidden" name="restart" value="1">
                <button type="submit" class="restart-btn">
                    Restart Story
                </button>
            </form>
        </div>

        <!-- Story Mode Layout with Context Panel -->
        <div class="story-layout">
            <div class="dictation-header">
                <h1>{{ story_title }}</h1>
                <p class="hsk-level"><strong>Level:</strong> {{ difficulty }}</p>
            </div>
            {% if current and total %}
            <div class="session-progress-container">
                <div class="session-progress-info">
                    <span class="session-counter">Sentence {{ current }} of {{ total }}</span>
                    <span class="session-percentage">{{ ((current / total) * 100) | round(0) | int }}%</span>
                </div>
                <div class="segmented-progress-bar">
                    {% set num_groups = (total // 5) %}
                    {% set remainder = total % 5 %}
                    {% for i in range(num_groups + (1 if remainder else 0)) %}
                        {% set segment_size = 5 if i < num_groups else remainder %}
                        {% set start = i * 5 + 1 %}
                        {% set end = start + segment_size - 1 %}
                        {% set filled = (current > end) %}
                        {% set partial = (current >= start and current <= end) %}
                        <div class="progress-segment">
                            <div class="progress-segment-fill{% if filled %} completed{% endif %}"
                                 style="width: {% if filled %}100{% elif partial %}{{ ((current - start + 1) / segment_size) * 100 }}{% else %}0{% endif %}%">
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            <div class="story-panels-row">
                <div class="story-context-panel">
                    <h3>Story Context</h3>
                    <button class="toggle-button" onclick="toggleTranslations()">Show Pinyin</button>
                    <div class="context-content">
                        {% if story_context and story_context|length > 0 %}
                            {% for part in story_context %}
                                <div class="context-part">
                                    <div class="context-text">{{ part.chinese }}</div>
                                    <div class="context-pinyin hidden">{{ part.pinyin }}</div>
                                    <div class="context-translation hidden">{{ part.translation }}</div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="no-context"><em>This is the beginning of the story. Previous context will appear here as you progress.</em></p>
                        {% endif %}
                    </div>
                </div>
                <div class="dictation-frame">
                    <h3>Dictation</h3>
                    {% if audio_file %}
                        <audio controls autoplay>
                            <source src="{{ url_for('static', filename=audio_file) }}" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                    {% else %}
                        <div class="no-audio-notice">
                            <p><strong>Story Mode:</strong> Read the text below and type what you see.</p>
                        </div>
                    {% endif %}

                    {% if not show_result %}
                        {{ dictation_form(false, request.path, false, show_next_button) }}
                    {% else %}
                        {{ dictation_form(true, request.path, true, show_next_button) }}
                        <div class="result">
                            <h3>{{ result }}</h3>
                            <p><strong>Correct sentence:</strong> {{ correct_sentence }}</p>
                            <p><strong>Correction:</strong> {{ correction|safe }}</p>
                            <p><strong>Pinyin:</strong> {{ pinyin }}</p>
                            <p><strong>Translation:</strong> {{ translation }}</p>
                            <p><strong>Accuracy:</strong> {{ accuracy }}%</p>
                        </div>
                        {% if not show_next_button %}
                            <a href="/stories">Back to Stories</a>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    {% else %}
        <!-- Regular Session Layout -->
        <h1>Chinese Dictation</h1>

        {% if session_mode %}
            <!-- Session Progress Bar -->
            <div class="session-progress-container">
                <div class="session-progress-info">
                    <span class="session-counter">Sentence {{ current }} of {{ total }}</span>
                    <span class="session-percentage">{{ ((current / total) * 100) | round(0) | int }}%</span>
                </div>
                <div class="segmented-progress-bar">
                    {% set num_groups = (total // 5) %}
                    {% set remainder = total % 5 %}
                    {% for i in range(num_groups + (1 if remainder else 0)) %}
                        {% set segment_size = 5 if i < num_groups else remainder %}
                        {% set start = i * 5 + 1 %}
                        {% set end = start + segment_size - 1 %}
                        {% set filled = (current > end) %}
                        {% set partial = (current >= start and current <= end) %}
                        <div class="progress-segment">
                            <div class="progress-segment-fill{% if filled %} completed{% endif %}"
                                 style="width: {% if filled %}100{% elif partial %}{{ ((current - start + 1) / segment_size) * 100 }}{% else %}0{% endif %}%">
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <p><strong>Level:</strong> {{ difficulty }}</p>

        {% if audio_file %}
            <audio controls autoplay>
                <source src="{{ url_for('static', filename=audio_file) }}" type="audio/mpeg">
                Your browser does not support the audio element.
            </audio>
        {% endif %}

        {% if not show_result %}
            {{ dictation_form(false, '/session', false, show_next_button) }}
        {% else %}
            {{ dictation_form(true, '/session', true, show_next_button) }}
            <div class="result">
                <h3>{{ result }}</h3>
                <p><strong>Correct sentence:</strong> {{ correct_sentence }}</p>
                <p><strong>Correction:</strong> {{ correction|safe }}</p>
                <p><strong>Pinyin:</strong> {{ pinyin }}</p>
                <p><strong>Translation:</strong> {{ translation }}</p>
                <p><strong>Accuracy:</strong> {{ accuracy }}%</p>
            </div>
            {% if not show_next_button %}
                <a href="/">Back to Menu</a>
            {% endif %}
        {% endif %}
    {% endif %}

    <script>
        window.onload = function() {
            const input = document.getElementById("user_input");
            if (input) input.focus();
        };

        // Only require input for the Submit button
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('dictation-form');
            const userInput = document.getElementById('user_input');
            const submitBtn = document.getElementById('submit-answer-btn');

            if (form && userInput && submitBtn) {
                form.addEventListener('submit', function(e) {
                    // Only require input if the submit button was used
                    if (document.activeElement === submitBtn) {
                        if (!userInput.value.trim()) {
                            e.preventDefault();
                            userInput.focus();
                            userInput.setCustomValidity('Please enter your answer.');
                            userInput.reportValidity();
                        } else {
                            userInput.setCustomValidity('');
                        }
                    } else {
                        // For other form submissions, allow empty input
                        userInput.setCustomValidity('');
                    }
                });
            }
            // Also clear custom validity on input
            if (userInput) {
                userInput.addEventListener('input', function() {
                    userInput.setCustomValidity('');
                });
            }
        });

        function toggleTranslations() {
            const button = document.querySelector('.toggle-button');
            const pinyinElements = document.querySelectorAll('.context-pinyin');
            const translationElements = document.querySelectorAll('.context-translation');
            
            const pinyinHidden = pinyinElements[0].classList.contains('hidden');
            const translationHidden = translationElements[0].classList.contains('hidden');
            
            if (pinyinHidden && translationHidden) {
                // First click: Show pinyin only
                pinyinElements.forEach(el => el.classList.remove('hidden'));
                translationElements.forEach(el => el.classList.add('hidden'));
                button.textContent = 'Show English';
                button.classList.add('active');
            } else if (!pinyinHidden && translationHidden) {
                // Second click: Show both pinyin and English
                pinyinElements.forEach(el => el.classList.remove('hidden'));
                translationElements.forEach(el => el.classList.remove('hidden'));
                button.textContent = 'Hide All';
                button.classList.add('active');
            } else {
                // Third click: Hide everything
                pinyinElements.forEach(el => el.classList.add('hidden'));
                translationElements.forEach(el => el.classList.add('hidden'));
                button.textContent = 'Show Pinyin';
                button.classList.remove('active');
            }
        }
    </script>
{% endblock %}
